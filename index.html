<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attestation de Suivi - Solioz & Merkli Travaux Publics SA</title>
  <!-- Import de la librairie jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
      body {
          font-family: Arial, sans-serif;
          background-color: #f4f4f4;
          margin: 0;
          padding: 20px;
          text-align: center;
      }
      .container {
          max-width: 500px;
          margin: auto;
          background: #fff;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      h2 {
          color: #2c3e50;
          font-size: 22px;
      }
      .logo {
          width: 120px;
          margin-bottom: 20px;
      }
      input, button {
          width: 100%;
          padding: 12px;
          margin-top: 10px;
          font-size: 16px;
          border: 1px solid #ccc;
          border-radius: 5px;
      }
      canvas {
          border: 2px solid #2c3e50;
          display: block;
          margin: 20px auto;
          border-radius: 5px;
          background-color: #fff;
      }
      .btn {
          background-color: #2c3e50;
          color: #fff;
          cursor: pointer;
          border: none;
      }
      .btn:hover {
          background-color: #34495e;
      }
      .radio-container {
          display: flex;
          justify-content: center;
          gap: 20px;
          margin-top: 20px;
      }
      .radio-container label {
          font-size: 16px;
          color: #34495e;
          cursor: pointer;
      }
      label input {
          margin-right: 5px;
      }
  </style>
</head>
<body>
  <div class="container">
    <img
      src="https://via.placeholder.com/150?text=Solioz+%26+Merkli"
      class="logo"
      alt="Solioz & Merkli"
    />
    <h2>Attestation de Suivi du Cours de Premiers Secours</h2>

    <form id="attestationForm">
      <input type="text" id="nom" placeholder="Nom" required />
      <input type="text" id="prenom" placeholder="Prénom" required />
      <p><strong>Date :</strong> <span id="dateActuelle"></span></p>

      <canvas id="signatureCanvas" width="400" height="200"></canvas>
      <button type="button" class="btn" onclick="effacerSignature()">Effacer la signature</button>

      <div class="radio-container">
        <label>
          <input type="radio" id="whatsapp" name="envoi" value="whatsapp" checked />
          WhatsApp
        </label>
        <label>
          <input type="radio" id="email" name="envoi" value="email" />
          E-mail
        </label>
      </div>

      <button type="button" class="btn" onclick="genererPDF()">Générer PDF & Envoyer</button>
    </form>
  </div>

  <script>
    // --- Affichage de la date actuelle ---
    document.getElementById('dateActuelle').innerText = new Date().toLocaleDateString();

    // --- Gestion de la signature ---
    let canvas = document.getElementById('signatureCanvas');
    let ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', function(event) {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(event.offsetX, event.offsetY);
    });

    canvas.addEventListener('mousemove', function(event) {
      if (drawing) {
        ctx.lineTo(event.offsetX, event.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', function() {
      drawing = false;
    });

    function effacerSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- Génération et envoi du PDF ---
    async function genererPDF() {
      const { jsPDF } = window.jspdf;

      let nom = document.getElementById('nom').value.trim();
      let prenom = document.getElementById('prenom').value.trim();
      let date = document.getElementById('dateActuelle').innerText;
      let envoiMode = document.querySelector('input[name="envoi"]:checked').value;

      if (!nom || !prenom) {
        alert("Veuillez remplir tous les champs.");
        return;
      }

      // Conversion de la signature en image
      let signatureImage = canvas.toDataURL("image/png");

      // Création du document PDF
      let doc = new jsPDF("p", "mm", "a4");

      // --- Mise en page plus professionnelle ---
      // Entête
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(20);
      doc.text("Attestation de Suivi", 105, 20, { align: "center" });
      
      doc.setFontSize(14);
      doc.text("Formation Premiers Secours", 105, 30, { align: "center" });
      
      // Logo (exemple : on peut le redimensionner et le positionner)
      // Si vous avez un logo en base64, vous pouvez l'insérer avec doc.addImage(logoData, ...)
      // doc.addImage(logoData, 'PNG', 10, 10, 30, 30);

      // Contenu principal
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(12);

      // Cadre / cadre d'infos
      doc.text("Solioz & Merkli Travaux Publics SA", 20, 50);

      doc.text(`Nom : ${nom}`, 20, 60);
      doc.text(`Prénom : ${prenom}`, 20, 65);
      doc.text(`Date : ${date}`, 20, 70);

      doc.text("Formatrice : Aurore Besse", 20, 80);
      
      // Thèmes suivis
      const themes = [
        "Chaîne de secours",
        "Législation",
        "ORA",
        "Numéros d'urgence",
        "RCP",
        "Insolation, coups de chaleur",
        "Hémorragie externe",
        "Électrocution",
        "Blessure par écrasement",
        "Étouffement",
        "Choc anaphylactique",
        "Crise cardiaque",
        "AVC"
      ];

      doc.text("Thèmes abordés :", 20, 90);
      let yPosition = 95;
      themes.forEach(theme => {
        doc.text(`- ${theme}`, 25, yPosition);
        yPosition += 5;
      });

      // Signature
      doc.text("Signature du participant :", 20, yPosition + 10);
      doc.addImage(signatureImage, "PNG", 20, yPosition + 15, 80, 40);

      // Export du PDF en Blob
      let pdfBlob = doc.output("blob");

      // Création d'une URL pour le blob (utilisée pour un éventuel téléchargement direct)
      let pdfUrl = URL.createObjectURL(pdfBlob);

      // --- Envoi / partage selon le mode sélectionné ---
      if (envoiMode === "whatsapp") {
        // Numéro corrigé +41274581379)
        // Pour que le partage fonctionne, le numéro doit être reconnu sur WhatsApp 
        // et l’utilisateur doit avoir WhatsApp installé (sur mobile ou WhatsApp Web ouvert).
        let whatsappUrl = `https://api.whatsapp.com/send?phone=41274581379&text=Attestation%20de%20suivi%20${nom}%20${prenom}.`;
        window.open(whatsappUrl, '_blank');

        // Téléchargement automatique du PDF pour l'envoyer en PJ si besoin
        doc.save(`Attestation_${nom}_${prenom}.pdf`);
      } else {
        // Tentative d'envoi par e-mail (note : mailto ne supporte pas réellement la pièce jointe automatique)
        // On ouvre le client mail, et on télécharge le PDF pour que l'utilisateur puisse l'ajouter en PJ
        let emailSubject = encodeURIComponent("Attestation de suivi");
        let emailBody = encodeURIComponent(
          "Veuillez trouver ci-joint l'attestation de " + nom + " " + prenom + "."
        );
        let mailtoLink = `mailto:ludo.betris@gmail.com?subject=${emailSubject}&body=${emailBody}`;
        window.open(mailtoLink, "_blank");

        // Téléchargement du PDF (l'utilisateur pourra l'attacher manuellement)
        doc.save(`Attestation_${nom}_${prenom}.pdf`);
      }

      alert("Attestation générée et procédure d'envoi lancée !");
    }
  </script>
</body>
</html>
