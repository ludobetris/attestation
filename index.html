<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attestation de Suivi - Solioz & Merkli Travaux Publics SA</title>
  <!-- Import de la librairie jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
      /* Empêcher le défilement horizontal */
      html, body {
          margin: 0;
          padding: 0;
          overflow-x: hidden;
          font-family: Arial, sans-serif;
          background-color: #f4f4f4;
          text-align: center;
      }
      .container {
          width: 90%;
          max-width: 600px;
          margin: 20px auto;
          background: #fff;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      h2 {
          color: #2c3e50;
          font-size: 22px;
          margin-bottom: 20px;
      }
      /* Le logo ne doit pas déborder sur les petits écrans */
      .logo {
          width: 120px;
          max-width: 100%;
          margin-bottom: 20px;
      }
      form {
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      input {
          width: 80%;
          padding: 12px;
          margin-top: 10px;
          font-size: 16px;
          border: 1px solid #ccc;
          border-radius: 5px;
          text-align: center;
      }
      /* Canvas ne déborde pas sur petits écrans */
      canvas {
          border: 2px solid #2c3e50;
          margin: 20px 0;
          border-radius: 5px;
          background-color: #fff;
          max-width: 100%;
          height: auto;
      }
      .btn {
          background-color: #2c3e50;
          color: #fff;
          cursor: pointer;
          border: none;
          padding: 12px 20px;
          font-size: 16px;
          border-radius: 5px;
          margin-top: 15px;
      }
      .btn:hover {
          background-color: #34495e;
      }
      .signature-btn {
          margin-top: 10px;
          background-color: #e74c3c;
      }
      .signature-btn:hover {
          background-color: #c0392b;
      }
  </style>
</head>
<body>
  <div class="container">
    <img
      src="https://github.com/ludobetris/3d-models/raw/main/logo___2019.png"
      class="logo"
      alt="Solioz & Merkli"
    />
    <h2>Attestation de Suivi du Cours de Premiers Secours</h2>

    <form id="attestationForm">
      <input type="text" id="nom" placeholder="Nom" required />
      <input type="text" id="prenom" placeholder="Prénom" required />
      <p><strong>Date :</strong> <span id="dateActuelle"></span></p>

      <canvas id="signatureCanvas" width="300" height="150"></canvas>
      <button type="button" class="btn signature-btn" onclick="effacerSignature()">Effacer la signature</button>

      <button type="button" class="btn" onclick="genererPDF()">Générer PDF & Télécharger</button>
    </form>
  </div>

  <script>
    // --- Affichage de la date actuelle ---
    document.getElementById('dateActuelle').innerText = new Date().toLocaleDateString();

    // --- Gestion de la signature ---
    let canvas = document.getElementById('signatureCanvas');
    let ctx = canvas.getContext('2d');
    let drawing = false;

    // Quelques réglages pour la qualité du trait
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // Récupération de la position (souris)
    function getMousePos(canvas, evt) {
      let rect = canvas.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    // Récupération de la position (tactile)
    function getTouchPos(canvas, evt) {
      let rect = canvas.getBoundingClientRect();
      let touch = evt.touches[0];
      return {
        x: touch.clientX - rect.left,
        y: touch.clientY - rect.top
      };
    }

    // Événements souris
    canvas.addEventListener('mousedown', function(event) {
      drawing = true;
      ctx.beginPath();
      let pos = getMousePos(canvas, event);
      ctx.moveTo(pos.x, pos.y);
    });

    canvas.addEventListener('mousemove', function(event) {
      if (drawing) {
        let pos = getMousePos(canvas, event);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', function() {
      drawing = false;
    });

    canvas.addEventListener('mouseleave', function() {
      drawing = false;
    });

    // Événements tactiles
    canvas.addEventListener('touchstart', function(event) {
      event.preventDefault();
      drawing = true;
      ctx.beginPath();
      let pos = getTouchPos(canvas, event);
      ctx.moveTo(pos.x, pos.y);
    }, false);

    canvas.addEventListener('touchmove', function(event) {
      event.preventDefault();
      if (drawing) {
        let pos = getTouchPos(canvas, event);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }
    }, false);

    canvas.addEventListener('touchend', function(event) {
      event.preventDefault();
      drawing = false;
    }, false);

    // Effacer la signature
    function effacerSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // Fonction pour charger une image en base64
    function getImageAsDataURL(url) {
      return new Promise((resolve, reject) => {
        let img = new Image();
        // Important pour éviter certains soucis de crossOrigin
        img.crossOrigin = "anonymous";
        img.onload = function() {
          let tempCanvas = document.createElement("canvas");
          tempCanvas.width = img.width;
          tempCanvas.height = img.height;
          let tempCtx = tempCanvas.getContext("2d");
          tempCtx.drawImage(img, 0, 0);
          resolve(tempCanvas.toDataURL("image/png"));
        };
        img.onerror = function(err) {
          reject(err);
        };
        img.src = url;
      });
    }

    // --- Génération et téléchargement du PDF ---
    async function genererPDF() {
      const { jsPDF } = window.jspdf;

      let nom = document.getElementById('nom').value.trim();
      let prenom = document.getElementById('prenom').value.trim();
      let date = document.getElementById('dateActuelle').innerText;

      if (!nom || !prenom) {
        alert("Veuillez remplir tous les champs.");
        return;
      }

      // Conversion de la signature en image
      let signatureImage = canvas.toDataURL("image/png");
      
      // Chargement du logo en base64
      let logoData;
      try {
        logoData = await getImageAsDataURL("https://github.com/ludobetris/3d-models/raw/main/logo___2019.png");
      } catch (e) {
        console.error("Impossible de charger le logo :", e);
        logoData = null;
      }

      // Création du document PDF (format A4)
      let doc = new jsPDF("p", "mm", "a4");
      // Largeur du PDF = 210mm, hauteur = 297mm

      // Insérer le logo (centré) si on a pu le charger
      if (logoData) {
        // On réduit un peu la taille pour éviter qu'il ne prenne trop de place
        let logoWidth = 50;
        let logoHeight = 25;
        let centerX = 105 - (logoWidth / 2); // 105 = milieu de la page
        doc.addImage(logoData, "PNG", centerX, 10, logoWidth, logoHeight);
      }

      // Titre principal
      doc.setFont("Helvetica", "bold");
      doc.setFontSize(20);
      // Position du texte : y = 50 après le logo
      doc.text("Attestation de Suivi", 105, 50, { align: "center" });

      doc.setFontSize(14);
      doc.text("Formation Premiers Secours", 105, 58, { align: "center" });

      // Infos (centrées)
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(12);

      let yPos = 72;
      doc.text(`Nom : ${nom}`, 105, yPos, { align: "center" });
      yPos += 6;
      doc.text(`Prénom : ${prenom}`, 105, yPos, { align: "center" });
      yPos += 6;
      doc.text(`Date : ${date}`, 105, yPos, { align: "center" });
      yPos += 6;
      doc.text("Formatrice : Aurore Besse", 105, yPos, { align: "center" });

      // Thèmes suivis
      const themes = [
        "Chaîne de secours",
        "Législation",
        "ORA",
        "Numéros d'urgence",
        "RCP",
        "Insolation, coups de chaleur",
        "Hémorragie externe",
        "Électrocution",
        "Blessure par écrasement",
        "Étouffement",
        "Choc anaphylactique",
        "Crise cardiaque",
        "AVC"
      ];

      yPos += 10;
      doc.setFont("Helvetica", "bold");
      doc.text("Thèmes abordés :", 105, yPos, { align: "center" });
      doc.setFont("Helvetica", "normal");

      yPos += 6;
      themes.forEach(theme => {
        doc.text(`- ${theme}`, 105, yPos, { align: "center" });
        yPos += 6;
      });

      // Signature
      yPos += 10;
      doc.setFont("Helvetica", "bold");
      doc.text("Signature du participant :", 105, yPos, { align: "center" });
      yPos += 5;

      // On insère la signature, largeur 80mm x hauteur 40mm
      let signatureWidth = 80;
      let signatureHeight = 40;
      let signatureX = 105 - (signatureWidth / 2);
      doc.addImage(signatureImage, "PNG", signatureX, yPos, signatureWidth, signatureHeight);

      // Nom du fichier PDF
      let fileName = `Attestation_${nom}_${prenom}.pdf`;

      // Téléchargement du PDF
      doc.save(fileName);

      // Message après téléchargement
      alert("Le PDF a été téléchargé. Veuillez envoyer ce fichier à la direction.");
    }
  </script>
</body>
</html>

